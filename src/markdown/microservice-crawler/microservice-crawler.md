---
title: '마이크로서비스의 관점에서 크롤러 만들기 (1) 구조 설계'
description: 'GCP가 제공하는 이벤트 스트리밍 시스템을 중심으로'
date: 2022-12-09T15:17:03+09:00
draft: true
tags: ['microservice', 'GCP']
slug: 'microservice-crawler'
category: 'dev'
---

#### 들어가며

회사에서 두 번째로 맡은 프로젝트는 다나와의 가전제품 데이터를 주기적으로 저장하는 크롤러를 만드는 일이었다.
백오피스 관리자가 특정 카테고리의 상품군을 수집 요청하면 크롤러가 원천 데이터를 모아들이고, 백오피스 서버가 더 정제된 형태로 원천 데이터를 재수집해가는 흐름을 만드는 것이 팀의 목표였다.

요구사항은 다음과 같았다.

- 한번 크롤링한 상품은 주기적으로 다시 크롤링해 최신 최저가 정보를 누적 저장할 것
- 마이크로 서비스 형태로 제작하여 안정성을 높일 것
- 기존 파이썬 크롤러보다 속도를 향상시킬 것
- 추후 다른 마켓을 크롤링할 수 있음을 염두에 둘 것

최근 팀의 화두가 마이크로서비스 설계를 지향하여 한 명의 개발자가 하나의 서비스를 완결되게 책임지는 것이었으므로, 서비스와 서비스 간의 배치부터 서비스 내의 세밀한 작업 흐름까지 모두 느슨히 연결된 구조로 만들어내고자 하였다. 내가 맡은 크롤러 또한 내부적으로 하나의 역할만 맡는 리소스들이 서로 통신하며 크롤링을 진행하도록 구현되었다.

###### 결과물 미리보기

![crawling-danawa](crawling-danawa.gif)

#### 대체 마이크로서비스가 뭘까?

마이크로서비스의 핵심 키워드는 '기능 분해'라고 할 수 있다. 히나의 코드 베이스, 하나의 서비스로 묶여 있던 모놀리식 아키텍처를 각각의 서비스, 각각의 DB로 분리하여 배치하는 것이 마이크로서비스 아키텍처의 시작이다. 하지만 이건 외견상의 '분해'일 뿐이다. 사상적인 측면에서의 '기능 분해'란, 전체 어플리케이션을 관리 가능한 최소한의 단위로 응집화, 모듈화시키는 것이다. 서비스를 작은 단위로 모듈화시키면 각 팀이 자율적으로 움직이게 되고, 기능 오류나 서비스 과부하의 리스크를 분산할 수 있으며 배포와 확장이 용이해진다. 새로운 기술 도입이 쉬워진다는 장점은 덤으로 들어온다.

물론 마이크로서비스에 장점만 있는 것은 아니다. 하나의 서비스가 실패하더라도 전체 어플리케이션이 여전히 동작하도록 가용성을 유지하는 것, 서비스 간에 복잡하게 오고가는 요청들을 안정적으로 관리하는 것이 개발팀에 있어서 어려운 과제가 될 것이다.

모놀리식 아키텍처에 비해 늘어나는 관리 포인트 부담을 줄이기 위해 우리 팀은 GCP가 제공하는 서비스를 최대한 이용하기로 결정했다. 이번 포스팅에선 마이크로서비스 형태로 크롤러를 구축하면서 어떤 방식으로 구조를 설계했고, 각 포인트마다 어떤 GCP 서비스를 사용했는지 소개하고자 한다.

#### 크롤러 기능 분해하기

크롤러는 다나와 웹사이트의 카테고리 페이지를 분석하는 과정, 각 페이지를 병렬적으로 방문하며 상품 세부 정보를 모아들이는 과정, 수집한 데이터를 DB에 저장하는 과정까지 세 가지로 나뉜다.

#### GCP Pub/Sub 이벤트 스트리밍 서비스

#### 구조 설계

#### Cloud Tasks 메시지 큐가 함께 필요했던 이유

#### 다믐 단계: terraform을 이용한 인프라 형상관리
